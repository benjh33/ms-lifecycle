- name: Directories are created
  file:
    path: "{{ item }}"
    state: directory
  with_items: "{{ directories }}"
  tags: [consul]

- name: Files are copied
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode }}"
  with_items: "{{ files }}"
  register: files
  tags: [consul]

- name: Templates are present
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode }}"
  with_items: "{{ templates }}"
  register: templates
  tags: [consul]

# dynamically set consul_extra
- name: Set consul_extra if host is consul server
  set_fact:
    consul_extra: -server -bootstrap 
  when: ec2_tag_Name == "serv-disc-0"

- name: Is running
  shell: "nohup consul agent {{ consul_extra }} \
    -data-dir {{ data_dir }} \
    -config-dir {{ config_dir }} \
    -node={{ ec2_tag_Name }} \
    -bind={{ ip }} \
    -client=0.0.0.0 \
    >{{ logs_dir }}/consul.log 2>&1 &"
  tags: [consul]

- name: Has joined
  shell: consul join {{ groups['consul_server'][0] }}
  when: ec2_tag_Name != "serv-disc-0"
  tags: [consul]

- name: Consul is restarted
  shell: killall -HUP consul
  when: files|changed or templates|changed
  tags: [consul]
