- name: Directories are created
  file:
    path: "{{ item }}"
    state: directory
  with_items: "{{ directories }}"

- name: Files are copied
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode }}"
  with_items: "{{ files }}"

- name: set first to be the console_server
  set_fact:
    consul_server: "{{ item.key }}"
  with_dict: "{{ hostvars }}"
  when: item.value['ec2_tag_Name'] in ['serv_disc', 'serv_disc_0']

# dynamically set consul_extra
- name: Set consul_extra if host is consul server
  set_fact:
    consul_extra: -server -bootstrap 
  when: ansible_default_ipv4.address == consul_server

- name: Is running
  shell: "kill -9 $(pidof consul); nohup consul agent {{ consul_extra }} \
    -ui \
    -data-dir /data/consul/data \
    -config-dir /data/consul/config \
    -node={{ ec2_tag_Name }} \
    -bind={{ ansible_default_ipv4.address }} \
    -client=0.0.0.0 \
    >{{ logs_dir }}/consul.log 2>&1 &"

- name: Has joined
  shell: consul join {{ consul_server }}
  retries: 5
  delay: 1
  when: ansible_default_ipv4.address != consul_server

